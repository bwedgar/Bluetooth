<!DOCTYPE html>

<html>

<head>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="apple-touch-icon" href="launch.png">
  <link rel="apple-touch-startup-image" href="launch.png">

  <link rel="canonical" href="https://bwedgar.github.io/Bluetooth" />

  <title>Bluetooth</title>
  <meta name="apple-mobile-web-app-title" content="Bluetooth">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">


  <meta http-equiv="refresh" content="600">
  <style>
    .button1 {
      background-color: black; //#4CAF50;
      /* Green */
      width: 20%;
      border: 2px solid white;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      float: left;
      border: 1px solid green;
      display: inline-block;
      font-size: 16px;
    }

    .button2 {
      background-color: black; //#4CAF50;
      /* Green */
      width: 10%;
      border: 2px solid white;
      color: white;
      padding: 15px 3px;
      text-align: center;
      text-decoration: none;
      //  display: inline-block;
      float: left;
      border: 1px solid green;
      font-size: 16px;
    }

    .button2On {

      background-color: grey; //#4CAF50;
      /* Green */
      width: 10%;
      border: 2px solid white;
      color: black;
      padding: 15px 3px;
      text-align: center;
      text-decoration: none;
      //  display: inline-block;
      float: left;
      border: 1px solid green;
      font-size: 16px;

    }
  </style>

</head>

<body style="background-color:white;color:black;font-family:courier;font-size:40px;text-align:center;>
  <div style=" font-size:300px;border: 6px solid red;border-radius: 100px;margin:auto;width:75%">T </div>
  <div><br>BLE controller v2.5 <a style="color:red;" href="https://bwedgar.github.io">bwedgar</a></div>
  <br>
  <button id="find">find bluetooth MyESP32 6</button>
  <BR>
  <button id="codeDisplay">code</button>

  <audio id="steam" src="steam.mp3" preload="auto"></audio>
  <audio id="seagull" src="seagull.mp3" preload="auto"></audio>
  <audio id="Cats" src="Cats.mp3" preload="auto"></audio>
  <audio id="Chickens" src="Chickens.mp3" preload="auto"></audio>

  <button id="start" class="button">start</button><br>
  <button id="play" class="button">play</button><br>
  <br>
  <div id="output"></div>


  <script>
    var tracks;
    var steamSound;
    var seagullSound;
    var CatsSound;
    var ChickensSound;

    sendCode = (code) => {
      v = new Uint8Array(1);
      v[0] = code;
  //    myCharacteristic.writeValue(v);
    }

    pannerList = [
      [0.01, 0.01], //[0] centre
      [-1, -1], //[1]=left
      [1, 1], //[2]=right
      [-1, 0.01], //[3]=left to centre
      [0.01, 1], //[4]=centre to right
      [1, 0.01], //[5]= right to centre
      [0.01, -1], //[6]=centre to left
      [-1, 1], //[7] left to right
      [1, -1] // [8] right to left
    ];


    var started = false;
    output = document.getElementById("output");

    start = () => {
      if (started == false) {
        started = true;
        audioCtx = new(window.AudioContext || window.webkitAudioContext)();

        steamSound = new Sound("steam");
        seagullSound = new Sound("seagull");
        CatsSound = new Sound("Cats");
        ChickensSound = new Sound("Chickens");


      }
    }


    class Sound {
      constructor(soundName) {
        this.soundName = soundName;
        this.fileName = this.soundName + ".mp3";
        this.audioElement = document.getElementById(soundName);
        console.log(this.audioElement.play());

        this.duration = this.audioElement.duration;
        //output.innerHTML = output.innerHTML + this.duration + "  ";
        this.track = audioCtx.createMediaElementSource(this.audioElement);
        this.gainNode = audioCtx.createGain();
        this.gainNode.gain.value = 1;
        //  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        this.panner = audioCtx.createStereoPanner();

      }




      play(pannerNumber) {
        this.track.connect(this.gainNode).connect(this.panner).connect(audioCtx.destination);
        this.audioElement.play();
        this.audioElement.muted = false;
        this.start = pannerList[pannerNumber][0];
        this.end = pannerList[pannerNumber][1];
        this.panner.pan.setValueAtTime(this.start, audioCtx.currentTime);
        this.panner.pan.linearRampToValueAtTime(this.end, audioCtx.currentTime + this.duration);

      }
    }

    class Track {
      constructor(time, soundName, panValue) {
        this.time = time;
        this.soundName = soundName;
        this.panValue = panValue;
      }
      play() {
        this.soundName.play(this.panValue);
      }
    }

  //  document.getElementById("start").addEventListener("click", () => {
    //  start();
//    });



    //BLE device types
    //servo 00
    //fibre 01
    //lights 10
    //tracks 11


    servo = function(id, pos) {
      //id 0-8,  pos 0-8
      //deciphering code for esp32
      code = (0 * 64 + id * 8 + pos)
      sendCode(code);
      codeString = code.toString(2).padStart(8, "0")
      codeId = Math.floor(code / 8) - Math.floor(code / 64) * 64
      codePos = code - Math.floor(code / 8) * 8

      alert(codeString + " " + codeId + " " + codePos)
    }

    fibre = function(id, state) {
      //id 0-8, state 0-8
      code = 1 * 64 + id * 8 + state
      sendCode(code);
      alert(code.toString(2).padStart(8, "0"))
    }

    on = 1
    off = 0

    lights = function(id, colour, change) {
      //id 0-4 color 0-2 change 0-1
      code = 2 * 64 + id * 16 + colour * 4 + change
      sendCode(code);
      alert(code.toString(2).padStart(8, "0"))
    }

    east = 0
    south = 1
    west = 2
    sky = 3

    red = 0
    green = 1
    blue = 2

    up = 1
    down = 0



    loco = function(track, nextStop) {}

    sound = function(name, pannerNumber) {
    name.play(pannerNumber);
  //  ChickensSound.play(0);
    };

    play = document.getElementById("play");
    play.addEventListener('click', function(event) {
    action = setTimeout(servo, 3000, 5, 7);
    action = setTimeout(sound, 4000, steamSound, 8);
    action = setTimeout(servo, 5000, 7, 3);

  //  action = setTimeout(lights, 7000, sky, red, up);

});


    x = document.getElementById("start");




    x.addEventListener('click', function(event) {
start();

      /*

      navigator.bluetooth.requestDevice({
          filters: [{
            namePrefix: 'MyESP32'
          }],
          optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
        })
        //  });



        .then(function(device) {
          // Step 2: Connect to it
          console.log("connecting to device");
          return device.gatt.connect();

        })

        .then(function(server) {
          // Step 3: Get the Service
          console.log("connecting to service");
          return server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');

        })

        .then(function(service) {
          // Step 4: get the Characteristic
          console.log("getting characteristic");
          return service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');

        })
        .then(function(characteristic) {
          myCharacteristic = characteristic;
          // Step 5: Write to the characteristic
          var data = new Uint8Array([0x41]);
          console.log("writing to characteristic");

          return characteristic.writeValue(data);
        })
        .catch(function(error) {
          // And of course: error handling!
          console.error('Connection failed!', error);
        });
*/

    });
  </script>

</body>

</html>
