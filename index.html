<!DOCTYPE html>

<html>

<head>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="apple-touch-icon" href="launch.png">
  <link rel="apple-touch-startup-image" href="launch.png">

  <link rel="canonical" href="https://bwedgar.github.io/Bluetooth" />

  <title>Bluetooth</title>
  <meta name="apple-mobile-web-app-title" content="Bluetooth">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta http-equiv="refresh" content="600">
  <style>
    span {
      display: inline-block;
      width: 21px;
    }

    .button1 {
      background-color: black; //#4CAF50;
      /* Green */
      width: 20%;
      border: 2px solid white;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      float: left;
      border: 1px solid green;
      display: inline-block;
      font-size: 16px;
    }

    .button2 {
      background-color: black; //#4CAF50;
      /* Green */
      width: 10%;
      border: 2px solid white;
      color: white;
      padding: 15px 3px;
      text-align: center;
      text-decoration: none;
      //  display: inline-block;
      float: left;
      border: 1px solid green;
      font-size: 16px;
    }

    .button2On {

      background-color: grey; //#4CAF50;
      /* Green */
      width: 10%;
      border: 2px solid white;
      color: black;
      padding: 15px 3px;
      text-align: center;
      text-decoration: none;
      //  display: inline-block;
      float: left;
      border: 1px solid green;
      font-size: 16px;

    }
  </style>


</head>

<body style="background-color:white;color:black;font-family:courier;font-size:40px;text-align:center;>
  <div style=" font-size:300px;border: 6px solid red;border-radius: 100px;margin:auto;width:75%">T</div>
  <div><br>BLE controller v16 </div>
  <br>
  <button id="setup" style="font-size:5vw;">setup</button>
  <button id="run" style="font-size:5vw;">run</button>
  <br>

  <span>
    B
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000111>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000110>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000101>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000100>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000011>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000010>
  </span>
  <span>
    <input type="radio" class="back" name="back" value=0b11000001>
  </span>
  <span>

  </span>
  <br>
  <span>
    F
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11001000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11010000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11011000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11100000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11101000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11110000>
  </span>
  <span>
    <input type="radio" class="front" name="front" value=0b11111000>
  </span>
  <span>
  </span>
  <br>

  <span>
    N
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00000000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00001000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00010000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00011000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00100000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00101000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00110000>
  </span>
  <span>
    <input type="radio" class="servonumber" name="servonumber" value=0b00111000>
  </span>
  <br>

  <span>
    P
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000000>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000001>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000010>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000011>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000100>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000101>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000110>
  </span>
  <span>
    <input type="radio" class="servo" name="servo" value=0b00000111>
  </span>
  <br>

  <span>
    L
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01110000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01101000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01100000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01011000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01010000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01001000>
  </span>
  <span>
    <input type="checkbox" class="light" name="light" value=0b01000000>
  </span>
  <span>
  </span>
  <br>

  <div id="output" style="font-size:5vw;"></div><br>
  <textarea id="commands" cols=50 rows=10 oninput="updateLocalStorage()" style="font-size:5vw;"></textarea><br>


  <audio id="steam" src="steam.mp3" preload="auto"></audio>
  <audio id="seagulls" src="seagulls.mp3" preload="auto"></audio>
  <audio id="cats" src="cats.mp3" preload="auto"></audio>
  <audio id="chickens" src="chickens.mp3" preload="auto"></audio>

  <script>
    var trackCodeFront;
    var trackCodeBack;
    var servoNumber = 0;


    var tracks;
    var steam;
    var seagulls;
    var cats;
    var chickens;

    var myCharacteristic;

    var output = document.getElementById("output")
    var commands = document.getElementById("commands")
    commands.value = localStorage.getItem("content")

    updateLocalStorage = function() {
      localStorage.setItem("content", commands.value)
    }

    setup = document.getElementById("setup");
    run = document.getElementById("run");

    radioButtonsFront = document.querySelectorAll('.front');
    radioButtonsBack = document.querySelectorAll('.back');
    radioButtonsServoNumber = document.querySelectorAll('.servonumber');
    radioButtonsServo = document.querySelectorAll('.servo');
    radioButtonsLight = document.querySelectorAll('.light');
    radioButtonsLightOff = document.querySelectorAll('.lightoff');

    displayTime = () => {
      //  output.innerHTML = Math.floor((Date.now() - startTime) / 1000);

    }
    sendCode = (code) => {
      v = new Uint8Array(1);
      v[0] = eval("0b" + code.toString(2));
      console.log("sending code: ", code.toString(2).padStart(8, "0"));

      //myCharacteristic.writeValue(v);
      output.innerText = Math.floor((Date.now() - startTime) / 1000) + "  " + code.toString(2).padStart(8, "0")
    }

    pannerList = [
      [0.01, 0.01], //[0] centre
      [-1, -1], //[1]=left
      [1, 1], //[2]=right
      [-1, 0.01], //[3]=left to centre
      [0.01, 1], //[4]=centre to right
      [1, 0.01], //[5]= right to centre
      [0.01, -1], //[6]=centre to left
      [-1, 1], //[7] left to right
      [1, -1] // [8] right to left
    ];

    var started = false;
    output = document.getElementById("output");

    setupSound = () => {
      //  if (started == false) {
      started = true;
      audioCtx = new(window.AudioContext || window.webkitAudioContext)();

      steam = new Sound("steam");
      seagull = new Sound("seagull");
      cats = new Sound("cats");
      chickens = new Sound("chickens");
    }



    for (radioButton of radioButtonsFront) {
      radioButton.addEventListener('click', function(e) {
        trackCodeFront = this.value;
        sendCode(this.value | trackCodeBack);
      });
    }



    for (radioButton of radioButtonsBack) {
      radioButton.addEventListener('click', function(e) {
        trackCodeBack = this.value;
        sendCode(this.value | trackCodeFront);
      });
    }

    for (radioButton of radioButtonsServoNumber) {
      radioButton.addEventListener('click', function(e) {
        servoNumber = this.value;
      });
    }

    for (radioButton of radioButtonsServo) {
      radioButton.addEventListener('click', function(e) {
        //alert(this.value)
        sendCode(this.value | servoNumber);
      });
    }

    for (radioButton of radioButtonsLight) {
      radioButton.addEventListener('click', function(e) {
        //  alert("radio clicked  "+this.value)
        if (this.checked) {
          sendCode(this.value | 0b00000000);
        } else
          sendCode(this.value | 0b00000001);
      });
    }



    class Sound {
      constructor(soundName) {
        this.soundName = soundName;
        this.fileName = this.soundName + ".mp3";
        this.audioElement = document.getElementById(soundName);
        console.log(this.audioElement.play());

        this.duration = this.audioElement.duration;
        output.innerHTML = output.innerHTML + this.duration + "  ";
        this.track = audioCtx.createMediaElementSource(this.audioElement);
        this.gainNode = audioCtx.createGain();
        this.gainNode.gain.value = 1;
        //  gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        this.panner = audioCtx.createStereoPanner();
      }

      play(pannerNumber, time) {
        this.track.connect(this.gainNode).connect(this.panner).connect(audioCtx.destination);
        this.audioElement.play();
        this.audioElement.muted = false;
        this.start = pannerList[pannerNumber][0];
        this.end = pannerList[pannerNumber][1];
        this.panner.pan.setValueAtTime(this.start, audioCtx.currentTime);
        this.panner.pan.linearRampToValueAtTime(this.end, audioCtx.currentTime + time + this.duration);

      }
    }


    //BLE device types
    //servo 00
    //fibre 01
    //lights 10
    //tracks 11


    track = function(track0Position, track1Position) {
      // track0position=0-7 track1Position=0-7
      code = (3 * 64 + Number(track0Position) * 8 + Number(track1Position))
      sendCode(code)
    }

    servo = function(id, pos) {
      //id 0-7,  pos 0-7
      code = (0 * 64 + Number(id) * 8 + Number(pos) * 1)
      sendCode(code)
    }

    fibre = function(id, state) {
      //id 0-8, state 0-8
      code = 1 * 64 + Number(id) * 8 + Number(state) * 1
      sendCode(code)
    }

    on = 1
    off = 0

    lights = function(channel, speed, change) {
      //channel 4 bits 0-10 east,south,west,skyx2 / speed 1 bit/ change 1  bit
      code = 2 * 64 + Number(channel) * 4 + Number(speed) * 2 + Number(change) * 1
      sendCode(code)
    }

    playSound = function(name, pan, time) {
      eval(name).play(pan, time);
    };

    toActions = function(line) {
      //alert(line);
      parameters = line.split(",")
      if (parameters[1] == "s") {
        action = setTimeout(servo, parameters[0] * 1000, parameters[2], parameters[3])
      }
      if (parameters[1] == "f") {
        action = setTimeout(fibre, parameters[0] * 1000, parameters[2], parameters[3])
      }

      if (parameters[1] == "l") {
        action = setTimeout(lights, parameters[0] * 1000, parameters[2], parameters[3], parameters[4])
      }

      if (parameters[1] == "t") {
        action = setTimeout(track, parameters[0] * 1000, parameters[2], parameters[3])
      }

      if (parameters[1] == "p") {
        action = setTimeout(playSound, parameters[0] * 1000, parameters[2], parameters[3], parameters[0] * 1000)
      }
    }


    run.addEventListener('click', function(event) {
      output.innerHTML = ""
      startTime = Date.now();
      setInterval(displayTime, 1000);
      text = commands.value;
      console.log(text)
      sw = ""
      for (i = 0; i < text.length; i++) {
        sw += text[i].charCodeAt() + ","
      }
      console.log(sw)

      //text = ": light l;\n: up 1,0;\n: steady 1,1;\n: down 0,1;\n: fibre f;\n: track t;\n: servo s;\n: eastRed light,6;\n: eastGreen light,7;\n"
      //text = text + ": eastBlue light,8;\n: sunrise \n0,eastRed,up\n5,eastGreen,up\n;\n4,sunrise\n6,sunrise\n30,l,3,1,0"

      //find the terms and their definitions

      words = text.matchAll(/: ([a-zA-Z0-9_,\s*]*);/g)

      //make a list of terms and their definitions
      terms = []
      definitions = []

      for (w of words) {
        t = w[1].split(/\s|\n|$/)[0]
        terms.push(t)
        d = w[1].slice(t.length + 1)
        definitions.push(d)
      }

      console.log("terms and defintions before substituation: ")
      for (i = 0; i < terms.length; i++) {
        console.log("terms: " + terms[i] + "  definition: " + definitions[i])
      }

      //substitute terms within definitions by their definitions
      for (i = 0; i < terms.length; i++) {
        for (j = 0; j < terms.length; j++) {
          definitions[i] = definitions[i].replaceAll(terms[j], definitions[j])
        }
      }

      console.log("AFTER SUBSTITUTIONS")
      console.log("terms and defintions before substituation: ")
      for (i = 0; i < terms.length; i++) {
        console.log("terms: " + terms[i] + "  definition: " + definitions[i])
      }
      //  console.log("text: "+text)


      //remove definitions
      text = text.replace(/:(.|\n)*?;/g, "")
      text = text.replace(/\n\n/g, "")

      //substitute terms in text with the defifinition of that term
      for (i = 0; i < terms.length; i++) {
        text = text.replaceAll(terms[i], definitions[i])
      }

      lines = []
      lines = text.split("\n")
      console.log("text: " + text)

      newText = ""
      wordTime = 0




      console.log("new text: " + newText)

      lines = text.split("\n")

      for (i = 0; i < lines.length; i++) {
        //if the line has form "4,5" then store the number 4 as word time
        captureWordTime = lines[i].match(/^(\d+),\d+,.*/)

        if (captureWordTime != null) {
          wordTime = parseInt(captureWordTime[1])
          console.log("lines: " + lines[i] + "   word time: " + wordTime)
          restOfLine = lines[i].match(/^\d+,(.+?)$/)
          if (restOfLine != null) {
            lines[i] = restOfLine[1]
          }
        }

        if (lines[i]=="") {
          wordTime=0
        }

        captureCommandTime = lines[i].match(/^(\d+),\w+/)
        if (captureCommandTime != null) {
          commandTime = captureCommandTime[1]
          console.log("lines: " + lines[i] + " word time:  " + parseInt(wordTime) + " command time:  " + parseInt(commandTime))
          restOfCommand = lines[i].match(/\d+,(.*)/)
          console.log("rest: " + restOfCommand[1])
          newCommandTime = parseInt(commandTime) + parseInt(wordTime)
          console.log("newCommandTime: " + newCommandTime)
          newCommand = newCommandTime + "," + restOfCommand[1]
          newText += newCommand + "\n"
          //console.log("new command: "+newCommand)
        }
      }

      console.log("after word time: " + newText)


      //send each line of text to the actions routine
      for (command of newText.split("\n")) {
        toActions(command)
      }
    });


    setup.addEventListener('click', function(event) {
      setupSound();
    });



    navigator.bluetooth.requestDevice({
        filters: [{
          namePrefix: 'MyESP32'
        }],
        optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
      })

      .then(function(device) {
        // Step 2: Connect to it
        console.log("connecting to device");
        return device.gatt.connect();
      })

      .then(function(server) {
        // Step 3: Get the Service
        console.log("connecting to service");
        return server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
      })

      .then(function(service) {
        // Step 4: get the Characteristic
        console.log("getting characteristic");
        return service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
      })
      .then(function(characteristic) {
        myCharacteristic = characteristic;
        // Step 5: Write to the characteristic
        var data = new Uint8Array([0x41]);
        console.log("writing to characteristic");
        return characteristic.writeValue(data);
      })

      .catch(function(error) {
        // And of course: error handling!
        console.error('Connection failed!', error);
      });
  </script>

</body>

</html>
